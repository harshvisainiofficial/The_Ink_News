<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}‡§¶ ‡§á‡§Ç‡§ï ‡§®‡•ç‡§Ø‡•Ç‡•õ{% endblock %}</title>
    <!-- Open Graph Meta Tags for Link Preview -->
    <meta property="og:site_name" content="‡§¶ ‡§á‡§Ç‡§ï ‡§®‡•ç‡§Ø‡•Ç‡•õ">
    <meta property="og:type" content="website">
    {% if news %}
        <meta property="og:title" content="{{ news.title | safe }}">
        {% set ns = namespace(first_image=None, first_video=None) %}
        {% for block in news.content_blocks %}
            {% if not ns.first_image and block.block_type == 'image' and (block.content.lower().endswith('.jpg') or block.content.lower().endswith('.jpeg') or block.content.lower().endswith('.png')) %}
                {% set ns.first_image = block %}
            {% endif %}
            {% if not ns.first_video and block.block_type == 'video' %}
                {% set ns.first_video = block %}
            {% endif %}
        {% endfor %}
        {% set domain = 'https://theinknews.com' %} {# Change to your actual domain if needed #}
        {% if ns.first_image %}
            {% set image_url = ns.first_image.content %}
            {% if not (image_url.startswith('http://') or image_url.startswith('https://')) %}
                {% set image_url = domain ~ image_url %}
            {% endif %}
            {% if not (image_url.lower().endswith('.jpg') or image_url.lower().endswith('.jpeg') or image_url.lower().endswith('.png')) %}
                {% set image_url = image_url ~ '.jpg' %}
            {% endif %}
            <meta property="og:image" content="{{ image_url }}">
        {% elif ns.first_video %}
            {% set video_url = ns.first_video.content %}
            {% if not (video_url.startswith('http://') or video_url.startswith('https://')) %}
                {% set video_url = domain ~ video_url %}
            {% endif %}
            <meta property="og:image" content="{{ video_url }}">
        {% else %}
            <meta property="og:image" content="https://res.cloudinary.com/dmvfrdzrl/image/upload/v1752772701/SharedUploads/ink-news-logo.png?f_auto,q_auto">
        {% endif %}
    {% else %}
        <meta property="og:title" content="‡§¶ ‡§á‡§Ç‡§ï ‡§®‡•ç‡§Ø‡•Ç‡•õ">
        <meta property="og:image" content="https://res.cloudinary.com/dmvfrdzrl/image/upload/v1752772701/SharedUploads/ink-news-logo.png?f_auto,q_auto">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <header>
        <div class="top-ad">
            {% if ad and ad.top_banner %}
                <img src="{{ ad.top_banner }}" alt="Top Banner Ad" style="max-width: 100%;">
            {% else %}
                <p>‡§Ø‡§π‡§æ‡§Ç ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç</p>
            {% endif %}
        </div>
        <div class="header-main">
            <div class="mobile-nav-toggle" id="mobile-nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="logo" style="display: flex; align-items: center;">
                <img src="https://res.cloudinary.com/dmvfrdzrl/image/upload/v1752772701/SharedUploads/ink-news-logo.png?f_auto,q_auto" alt="The Ink NEWS Logo" style="max-width: 150px; height: auto; display: block; margin: 0 auto;">
                <h1 style="margin: 0;" class="site-title">‡§¶ ‡§á‡§Ç‡§ï ‡§®‡•ç‡§Ø‡•Ç‡•õ</h1>
            </div>
            <nav class="top-nav">
                <ul>
                    <li><a href="{{ url_for('index') }}" {% if not selected_category %}class="active"{% endif %}>‡§π‡•ã‡§Æ</a></li>
                    <li><a href="{{ url_for('video') }}">‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã</a></li>
                    <li><a href="{{ url_for('search') }}">‡§ñ‡•ã‡§ú</a></li>
                    <li><a href="{{ url_for('epaper') }}">‡§à-‡§™‡•á‡§™‡§∞</a></li>
                    <li><button id="subscribe-btn" class="subscribe-btn">üîî ‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="left-nav-toggle" id="left-nav-toggle">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div class="left-nav-overlay" id="left-nav-overlay"></div>
    <div class="main-container">
        <aside class="left-nav" id="left-nav">
            <button class="close-nav" id="close-nav">‚úï</button>
            <ul>
                <li><a href="{{ url_for('live_news') }}">‡§≤‡§æ‡§á‡§µ ‡§®‡•ç‡§Ø‡•Ç‡•õ</a></li>
                <li><a href="{{ url_for('category', category='top-news') }}">‡§ü‡•â‡§™ ‡§®‡•ç‡§Ø‡•Ç‡•õ</a></li>
                <li>
                    <div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <a href="{{ url_for('rajya_shehar') }}" style="flex: 1;">‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§∂‡§π‡§∞</a>
                        <select onchange="if(this.value) window.location.href='{{ url_for('rajya_shehar') }}?city=' + encodeURIComponent(this.value);" style="margin-left: 10px; padding: 5px; font-size: 14px; border: 1px solid #eee; border-radius: 4px; width: 120px;">
                            <option value="">‡§∏‡§≠‡•Ä ‡§∂‡§π‡§∞</option>
                            {% for city in cities %}
                                <option value="{{ city }}" {% if city == selected_city %}selected{% endif %}>{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </li>
                <li><a href="{{ url_for('category', category='the-ink-khas') }}">‡§¶ ‡§á‡§Ç‡§ï ‡§ñ‡§æ‡§∏</a></li>
                <li><a href="{{ url_for('category', category='cricket') }}">‡§ï‡•ç‡§∞‡§ø‡§ï‡•á‡§ü</a></li>
                <li><a href="{{ url_for('category', category='sports') }}">‡§ñ‡•á‡§≤</a></li>
                <li><a href="{{ url_for('category', category='jiveen-mantra') }}">‡§ú‡•Ä‡§µ‡§® ‡§Æ‡§Ç‡§§‡•ç‡§∞</a></li>
                <li><a href="{{ url_for('category', category='business') }}">‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞</a></li>
            </ul>
        </aside>

        <main class="content">
            {% block content %}
                <section class="news-articles">
                    {% if news_articles %}
                        {% for article in news_articles %}
                            <article>
                                <div class="article-header">
                                    <h3>{{ article.title }}</h3>
                                    <a href="#" class="share-icon" data-url="{{ url_for('article', id=article.id, slug=article.title|slugify, _external=True) }}" title="Share this article">‚Üó</a>
                                </div>
                                {% if article.content_blocks %}
                                    {% for block in article.content_blocks %}
                                        {% if block.block_type == 'image' %}
                                            <img src="{{ block.content }}" alt="{{ article.title }}" class="news-image">
                                        {% endif %}
                                    {% endfor %}
                                    {% for block in article.content_blocks %}
                                        {% if block.block_type == 'text' %}
                                            <p>{{ block.content | safe }}</p>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                <a href="{{ url_for('article', id=article.id, slug=article.title|slugify) }}" class="read-more">‡§î‡§∞ ‡§™‡§¢‡§º‡•á‡§Ç</a>
                            </article>
                        {% endfor %}
                    {% else %}
                        <p>‡§ï‡•ã‡§à ‡§≤‡•á‡§ñ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç 'head_approved=True' ‡§≤‡•á‡§ñ‡•ã‡§Ç ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                    {% endif %}
                </section>
            {% endblock %}
        </main>

        <aside class="right-ad">
            {% if ad and ad.right_sidebar %}
                <img src="{{ ad.right_sidebar }}" alt="Right Sidebar Ad" style="max-width: 100%;">
            {% else %}
                <p>‡§Ø‡§π‡§æ‡§Ç ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç</p>
            {% endif %}
        </aside>
    </div>

    <div class="floating-logo">
        <img src="https://res.cloudinary.com/dmvfrdzrl/image/upload/v1752772701/SharedUploads/ink-news-logo.png?f_auto,q_auto" alt="The Ink NEWS Floating Logo">
    </div>

    <!-- Share Pop-up -->
    <div class="share-popup" id="share-popup" style="display: none;">
        <div class="share-popup-content">
            <button class="close-popup" id="close-popup">‚úï</button>
            <h3>‡§≤‡§ø‡§Ç‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç</h3>
            <input type="text" id="share-link" readonly>
            <button id="copy-link">‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
            <a id="whatsapp-share" href="#" target="_blank" class="whatsapp-btn">WhatsApp ‡§™‡§∞ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç</a>
        </div>
    </div>

    <footer>
        <p>¬© 2025 ‡§¶ ‡§á‡§Ç‡§ï ‡§®‡•ç‡§Ø‡•Ç‡•õ. ‡§∏‡§∞‡•ç‡§µ‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§‡•§</p>
    </footer>

    <script>
        // Navigation Toggles
        const mobileNavToggle = document.getElementById('mobile-nav-toggle');
        const leftNavToggle = document.getElementById('left-nav-toggle');
        const topNav = document.querySelector('.top-nav');
        const leftNav = document.getElementById('left-nav');
        const leftNavOverlay = document.getElementById('left-nav-overlay');
        const closeNav = document.getElementById('close-nav');

        mobileNavToggle.addEventListener('click', function() {
            topNav.classList.toggle('active');
            this.classList.toggle('active');
            leftNav.classList.remove('active');
            leftNavOverlay.classList.remove('active');
            leftNavToggle.classList.remove('active');
        });

        leftNavToggle.addEventListener('click', function() {
            leftNav.classList.toggle('active');
            leftNavOverlay.classList.toggle('active');
            this.classList.toggle('active');
            topNav.classList.remove('active');
            mobileNavToggle.classList.remove('active');
        });

        leftNavOverlay.addEventListener('click', function() {
            leftNav.classList.remove('active');
            leftNavOverlay.classList.remove('active');
            leftNavToggle.classList.remove('active');
        });

        closeNav.addEventListener('click', function() {
            leftNav.classList.remove('active');
            leftNavOverlay.classList.remove('active');
            leftNavToggle.classList.remove('active');
        });

        document.addEventListener('click', function(event) {
            if (!topNav.contains(event.target) && !mobileNavToggle.contains(event.target)) {
                topNav.classList.remove('active');
                mobileNavToggle.classList.remove('active');
            }
            if (!leftNav.contains(event.target) && !leftNavToggle.contains(event.target) && !leftNavOverlay.contains(event.target)) {
                leftNav.classList.remove('active');
                leftNavOverlay.classList.remove('active');
                leftNavToggle.classList.remove('active');
            }
        });

        // Share Pop-up Logic
        const shareIcons = document.querySelectorAll('.share-icon');
        const sharePopup = document.getElementById('share-popup');
        const shareLinkInput = document.getElementById('share-link');
        const copyLinkButton = document.getElementById('copy-link');
        const whatsappShareButton = document.getElementById('whatsapp-share');
        const closePopupButton = document.getElementById('close-popup');

        shareIcons.forEach(icon => {
            icon.addEventListener('click', function(event) {
                event.preventDefault();
                const url = this.getAttribute('data-url');
                shareLinkInput.value = url;
                // Set WhatsApp share link with pre-filled message
                const encodedUrl = encodeURIComponent(url);
                const message = encodeURIComponent('Check out this news article: ');
                whatsappShareButton.href = `https://api.whatsapp.com/send?text=${message}${encodedUrl}`;
                sharePopup.style.display = 'flex';
            });
        });

        copyLinkButton.addEventListener('click', function() {
            shareLinkInput.select();
            document.execCommand('copy');
            alert('‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à!');
        });

        closePopupButton.addEventListener('click', function() {
            sharePopup.style.display = 'none';
        });

        sharePopup.addEventListener('click', function(event) {
            if (event.target === sharePopup) {
                sharePopup.style.display = 'none';
            }
        });

        // Push Notification Subscription Logic
        const subscribeBtn = document.getElementById('subscribe-btn');
        let isSubscribed = false;
        let swRegistration = null;

        // VAPID public key (you'll need to generate this)
        const applicationServerPublicKey = 'BEl62iUYgUivxIkv69yViEuiBIa40HdHSWgMfHXPJeuNiJ7Ek00jVNPSyeQX-QbVFPLwqyBFWAlVfY9OCLXiAiA';

        function urlB64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        function updateSubscriptionOnServer(subscription, method) {
            const endpoint = method === 'POST' ? '/subscribe' : '/unsubscribe';
            
            return fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    endpoint: subscription.endpoint,
                    keys: {
                        p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))),
                        auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))))
                    }
                })
            });
        }

        function subscribeUser() {
            const applicationServerKey = urlB64ToUint8Array(applicationServerPublicKey);
            swRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: applicationServerKey
            })
            .then(function(subscription) {
                console.log('User is subscribed.');
                updateSubscriptionOnServer(subscription, 'POST')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateBtn();
                        alert('‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨ ‡§π‡•ã ‡§ó‡§è! ‡§Ö‡§¨ ‡§Ü‡§™‡§ï‡•ã ‡§®‡§à ‡§ñ‡§¨‡§∞‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§Æ‡§ø‡§≤‡•á‡§ó‡•Ä‡•§');
                    } else {
                        console.error('Failed to subscribe on server:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error updating subscription on server:', error);
                });
                isSubscribed = true;
            })
            .catch(function(err) {
                console.log('Failed to subscribe the user: ', err);
                alert('‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§');
            });
        }

        function unsubscribeUser() {
            swRegistration.pushManager.getSubscription()
            .then(function(subscription) {
                if (subscription) {
                    updateSubscriptionOnServer(subscription, 'DELETE')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            return subscription.unsubscribe();
                        } else {
                            throw new Error('Failed to unsubscribe on server');
                        }
                    })
                    .then(function(successful) {
                        console.log('User is unsubscribed.');
                        isSubscribed = false;
                        updateBtn();
                        alert('‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§®‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨ ‡§π‡•ã ‡§ó‡§è‡•§');
                    })
                    .catch(function(error) {
                        console.log('Error unsubscribing', error);
                    });
                }
            });
        }

        function updateBtn() {
            if (Notification.permission === 'denied') {
                subscribeBtn.textContent = 'üîï ‡§¨‡•ç‡§≤‡•â‡§ï‡•ç‡§°';
                subscribeBtn.disabled = true;
                return;
            }

            if (isSubscribed) {
                subscribeBtn.textContent = 'üîî ‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨‡•ç‡§°';
            } else {
                subscribeBtn.textContent = 'üîî ‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨';
            }

            subscribeBtn.disabled = false;
        }

        function initializeUI() {
            subscribeBtn.addEventListener('click', function() {
                subscribeBtn.disabled = true;
                if (isSubscribed) {
                    unsubscribeUser();
                } else {
                    subscribeUser();
                }
            });

            // Set the initial subscription value
            swRegistration.pushManager.getSubscription()
            .then(function(subscription) {
                isSubscribed = !(subscription === null);
                updateBtn();
            });
        }

        if ('serviceWorker' in navigator && 'PushManager' in window) {
            console.log('Service Worker and Push is supported');

            navigator.serviceWorker.register('/static/sw.js')
            .then(function(swReg) {
                console.log('Service Worker is registered', swReg);
                swRegistration = swReg;
                initializeUI();
            })
            .catch(function(error) {
                console.error('Service Worker Error', error);
            });
        } else {
            console.warn('Push messaging is not supported');
            subscribeBtn.textContent = '‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§';
            subscribeBtn.disabled = true;
        }
    </script>
</body>
</html>